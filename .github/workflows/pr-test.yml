# Pull Request æ¸¬è©¦å·¥ä½œæµç¨‹
# åœ¨ PR æ™‚è‡ªå‹•é‹è¡Œæ¸¬è©¦ä¸¦è©•è«–è¦†è“‹ç‡å ±å‘Š

name: ğŸ“ PR Tests

on:
  pull_request:
    branches: [main]

jobs:
  test-and-comment:
    name: æ¸¬è©¦ä¸¦è©•è«–è¦†è“‹ç‡
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10'

      - name: ğŸŸ¢ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª é‹è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡
        run: pnpm test:coverage
        continue-on-error: true

      - name: ğŸ“Š è®€å–è¦†è“‹ç‡æ‘˜è¦
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=N/A" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¬ è©•è«– PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const emoji = parseFloat(coverage) >= 80 ? 'ğŸ‰' : parseFloat(coverage) >= 60 ? 'âœ…' : 'âš ï¸';

            const comment = `## ${emoji} æ¸¬è©¦çµæœ

            ### ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡ï¼š${coverage}%

            ${parseFloat(coverage) >= 80 ? 'å¤ªæ£’äº†ï¼è¦†è“‹ç‡é”åˆ°å„ªç§€æ°´å¹³ï¼' :
              parseFloat(coverage) >= 60 ? 'è¦†è“‹ç‡è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼' :
              'å»ºè­°æé«˜æ¸¬è©¦è¦†è“‹ç‡åˆ° 60% ä»¥ä¸Š'}

            **è©³ç´°å ±å‘Š**: è«‹æŸ¥çœ‹ Actions é é¢ä¸‹è¼‰å®Œæ•´çš„è¦†è“‹ç‡å ±å‘Š

            ---
            ğŸ¤– ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ“ ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-coverage-report
          path: coverage/
          retention-days: 30

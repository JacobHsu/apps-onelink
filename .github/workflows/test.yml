# GitHub Actions è‡ªå‹•æ¸¬è©¦å·¥ä½œæµç¨‹
# æ¯æ¬¡ push æˆ– Pull Request æ™‚è‡ªå‹•é‹è¡Œæ¸¬è©¦

name: ğŸ§ª Tests

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ä»£ç¢¼è¢«æ¨é€åˆ°é€™äº›åˆ†æ”¯ï¼Œæˆ–å‰µå»º PR æ™‚
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# å®šç¾©ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10'

jobs:
  # ç¬¬ä¸€å€‹ Jobï¼šé‹è¡Œæ¸¬è©¦
  test:
    name: é‹è¡Œæ¸¬è©¦
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: æª¢å‡ºä»£ç¢¼
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­ç½® pnpm
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # æ­¥é©Ÿ 3: è¨­ç½® Node.js
      - name: ğŸŸ¢ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # æ­¥é©Ÿ 4: å®‰è£ä¾è³´
      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      # æ­¥é©Ÿ 5: é‹è¡Œæ¸¬è©¦
      - name: ğŸ§ª é‹è¡Œæ¸¬è©¦
        run: pnpm test:run

      # æ­¥é©Ÿ 6: ç”Ÿæˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
      - name: ğŸ“Š ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
        run: pnpm test:coverage
        continue-on-error: true  # å³ä½¿è¦†è“‹ç‡ä¸é”æ¨™ä¹Ÿç¹¼çºŒ

      # æ­¥é©Ÿ 7: ä¸Šå‚³è¦†è“‹ç‡å ±å‘Šåˆ° Codecovï¼ˆå¯é¸ï¼‰
      # éœ€è¦å…ˆåœ¨ https://codecov.io è¨»å†Šä¸¦ç²å– token
      # - name: ğŸ“¤ ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: ./coverage/coverage-final.json
      #     fail_ci_if_error: false

      # æ­¥é©Ÿ 8: ä¸Šå‚³è¦†è“‹ç‡å ±å‘Šç‚º Artifactï¼ˆå¯ä¸‹è¼‰æŸ¥çœ‹ï¼‰
      - name: ğŸ“ ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()  # å³ä½¿æ¸¬è©¦å¤±æ•—ä¹Ÿä¸Šå‚³
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ç¬¬äºŒå€‹ Jobï¼šæª¢æŸ¥ä»£ç¢¼å“è³ªï¼ˆLintï¼‰
  lint:
    name: ä»£ç¢¼æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      # å¦‚æœæœ‰ ESLint é…ç½®ï¼Œå–æ¶ˆè¨»è§£ä»¥ä¸‹è¡Œ
      # - name: ğŸ” é‹è¡Œ ESLint
      #   run: pnpm lint

  # ç¬¬ä¸‰å€‹ Jobï¼šå»ºæ§‹æª¢æŸ¥
  build:
    name: å»ºæ§‹æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ å»ºæ§‹å°ˆæ¡ˆ
        run: pnpm build

      # ä¸Šå‚³å»ºæ§‹çµæœï¼ˆå¯é¸ï¼‰
      - name: ğŸ“ ä¸Šå‚³å»ºæ§‹çµæœ
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .output/
          retention-days: 7
